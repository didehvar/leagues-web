var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Migration=function(){function e(){}return e}(),Migrator=function(){function e(e){this.migrations=[],this.progress=-100,this.migrations=e.sort(function(e,t){if(e.version<t.version)return-1;if(e.version>t.version)return 1;throw new Error("Duplicate migrations!")})}return e.executeMigrations=function(t){var n=this,r=[];if(!e.migrationsRunning){if("loading"==document.readyState)return void document.addEventListener("DOMContentLoaded",e.executeMigrations);e.formfillMigrationBackground.isEnabled()&&r.push(new FormfillAndNotesMigration);var o=new e(r),i=this.migrationBackground.getBlobVersion();null!==i&&o.hasPendingMigrations(i)&&(this.migrationBackground.publishState(!0),t&&o.setProgressCallback(t),o.migrate(i,function(){n.migrationBackground.publishState(!1)}))}},Object.defineProperty(e,"migrationBackground",{get:function(){return e.getBg().MigrationBackground},enumerable:!0,configurable:!0}),Object.defineProperty(e,"formfillMigrationBackground",{get:function(){return e.getBg().FormfillMigrationBackground},enumerable:!0,configurable:!0}),e.getBg=function(){return"undefined"!=typeof bg?bg:getBG()},e.prototype.setProgressCallback=function(e){this.progressCallback=e},e.prototype.hasPendingMigrations=function(e){for(var t=0,n=this.migrations;t<n.length;t++){if(e<n[t].version)return!0}return!1},e.prototype.migrate=function(t,n){var r=this;this.progress+=100,this.updateProgress();for(var o=0,i=this.migrations;o<i.length;o++){var a=i[o],s=function(e){if(t<e.version)return e.migrate(function(){r.migrate(e.version,n)},function(e,t){r.updateProgress(Math.floor(e/t*100))}),{value:void 0}}(a);if("object"==typeof s)return s.value}e.migrationBackground.saveBlobVersion(t,function(){n&&n(t)})},e.prototype.updateProgress=function(e){void 0===e&&(e=0),this.progressCallback&&this.progressCallback(this.progress+Math.min(e,100),100*this.migrations.length)},e}();Migrator.migrationsRunning=!1;var ObservableState=function(){function e(){this.stateSubscribers=[],this.isRunning=!1}return e.prototype.subscribeToState=function(e){this.stateSubscribers.push(e),this.isRunning&&e(this.isRunning)},e.prototype.publishState=function(e){this.isRunning=e;for(var t=0,n=this.stateSubscribers;t<n.length;t++){(0,n[t])(e)}},e}(),MigrationBackgroundWeb=function(e){function t(){var t=e.call(this)||this;return t.apiUrl="/lmiapi","string"==typeof base_url&&(t.apiUrl=base_url.replace(/\/$/,"")+t.apiUrl),t}return __extends(t,e),t.prototype.getBlobVersion=function(){return"undefined"!=typeof g_blob_version&&void 0!==g_blob_version.version?Number(g_blob_version.version):null},t.prototype.saveBlobVersion=function(e,t){var n=this;this.getToken(function(r){$.ajax({url:n.apiUrl+"/users/me/blobversion",method:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({version:e}),headers:{"x-csrf-token":r},success:function(){g_blob_version.version=e,t()}})})},t.prototype.sendSegmentEvent=function(e,t){sendLpImprove(e,t)},t.prototype.getToken=function(e){$.post(this.apiUrl+"/csrf",function(t){e(t)})},t}(ObservableState),MigrationBackgroundExtension=function(e){function t(){var t=e.call(this)||this;return t.apiUrl="/lmiapi","string"==typeof base_url&&(t.apiUrl=base_url.replace(/\/$/,"")+t.apiUrl),t}return __extends(t,e),t.prototype.getBlobVersion=function(){return"undefined"!=typeof g_blob_version&&void 0!==g_blob_version.version?Number(g_blob_version.version):null},t.prototype.saveBlobVersion=function(e,t){var n=this;this.getToken(function(r){LP.lpMakeRequestReallyReal(n.apiUrl+"/users/me/blobversion",JSON.stringify({version:e}),function(n){4===n.readyState&&200===n.status?(g_blob_version.version=e,t()):4===n.readyState&&lpmakerequesterror("invalidresponse",{url:n.responseURL},!1)},void 0,{"x-csrf-token":r,"Content-Type":"application/json"})})},t.prototype.sendSegmentEvent=function(e,t){sendLpImprove(e,t)},t.prototype.getToken=function(e){LP.lpMakeRequestReallyReal(this.apiUrl+"/csrf","",function(t){4===t.readyState&&200===t.status?e(JSON.parse(t.responseText)):4===t.readyState&&lpmakerequesterror("invalidresponse",{url:t.responseURL},!1)})},t}(ObservableState),FormfillStore=function(){function e(){}return e.prototype.getFormfills=function(){return this.decrypt(this.encryptedFormfills)},e.prototype.decrypt=function(e){for(var t=[],n=0,r=e;n<r.length;n++){var o=r[n],i=new FormFillType;for(var a in o)if(o.hasOwnProperty(a)){var s=void 0;if(i[a]=o[a],"custom_fields"===a){i[a]=[];for(var u in o[a]){i[a][u]=this.objectAssign({},o[a][u]);var p=i[a][u];for(var c in p)p[c]&&(s=this.lpmdec(p[c],!0))&&(p[c]=s)}}else i[a]&&(s=this.lpmdec(i[a],!0))&&(i[a]=s)}t.push(i)}return t},e.prototype.objectAssign=function(e,t){for(var n=1;n<arguments.length;n++){var r=arguments[n];if(null!=r)for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},e}(),FormFillType=function(){function e(){}return e.prototype.hasSocialSecurityNumber=function(){return!!this.ssn},e.prototype.hasAddressData=function(){return!!(this.title||this.firstname||this.middlename||this.lastname||this.username||this.gender||this.birthday||this.company||this.address1||this.address2||this.address3||this.city||this.county||this.timezone||this.email||this.phone||this.mobilephone||this.evephone||this.fax)},e.prototype.hasPaymentCardData=function(){return!!(this.ccname||this.ccnum||this.ccstart||this.ccexp||this.cccsc||this.ccissuenum)},e.prototype.hasBankNoteData=function(){return!!(this.bankname||this.bankroutingnum||this.bankacctnum)},e.prototype.hasCustomFields=function(){return!!this.custom_fields.length},e.prototype.getSerializedPhone=function(){return this.phone?JSON.stringify({num:this.phone,ext:this.phoneext,cc3l:this.phone3lcc}):""},e.prototype.getSerializedEveningPhone=function(){return this.evephone?JSON.stringify({num:this.evephone,ext:this.eveext,cc3l:this.evephone3lcc}):""},e.prototype.getSerializedMobilePhone=function(){return this.mobilephone?JSON.stringify({num:this.mobilephone,ext:this.mobileext,cc3l:this.mobilephone3lcc}):""},e.prototype.getSerializedFax=function(){return this.fax?JSON.stringify({num:this.fax,ext:this.faxext,cc3l:this.fax3lcc}):""},e}(),NoteType=function(){function e(){}return e}(),FormfillAndNotesMigration=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.fieldMaxLength=50,t.monthNames=["","January","February","March","April","May","June","July","August","September","October","November","December"],t.migrationQueue=[],t.successCallback=function(){},t.progress=-1,t.noteAdditionHandler=function(){t.executeNextMigration()},t}return __extends(t,e),Object.defineProperty(t.prototype,"version",{get:function(){return 20170404140712},enumerable:!0,configurable:!0}),t.prototype.migrate=function(e,t){this.successCallback=e,this.progressCallback=t,this.migrationBackground.sendSegmentEvent("migration::formfill::started"),this.migrateFormfills(),this.attachMigrationQueueExecutor()},t.prototype.migrateFormfills=function(){for(var e=this,t=this.formfillMigrationBackground.getFormfills(),n=this,r=0,o=t;r<o.length;r++){var i=o[r];!function(t){t.hasSocialSecurityNumber()&&n.migrationQueue.push(function(){e.saveSocialSecurityNumberNote(t)}),t.hasAddressData()&&n.migrationQueue.push(function(){e.saveAddressNote(t)}),t.hasPaymentCardData()&&n.migrationQueue.push(function(){e.savePaymentCardNote(t)}),t.hasBankNoteData()&&n.migrationQueue.push(function(){e.saveBankAccountNote(t)}),t.hasCustomFields()&&n.migrationQueue.push(function(){e.saveCustomFields(t)})}(i)}},t.prototype.saveSocialSecurityNumberNote=function(e){var t={group:e.group,name:e.decprofilename,notetype:this.getNoteTypes().SSN,pwprotect:e.pwprotect,fav:"0",language:e.profilelanguage,extra:{Name:e.firstname+" "+e.middlename+" "+e.lastname,Number:e.ssn,Notes:e.notes?""+e.notes:""}};this.saveNote(t)},t.prototype.saveAddressNote=function(e){var t=/([^-]*)-([^-]*)-([^-]*)/g.exec(e.birthday),n={group:e.group,name:e.decprofilename,notetype:this.getNoteTypes().ADDRESS,pwprotect:e.pwprotect,fav:"0",language:e.profilelanguage,extra:{Title:e.title,"First Name":e.firstname,"Middle Name":e.middlename,"Last Name":e.lastname,Username:e.username,Gender:e.gender,Birthday:t&&t.length>=3?this.monthNames[Number(t[2])]+","+t[3]+","+t[1]:",,",Company:e.company,"Address 1":e.address1,"Address 2":e.address2,"Address 3":e.address3,"City / Town":e.city,County:e.county,State:e.state,"Zip / Postal Code":e.zip,Country:e.country,Timezone:e.timezone,"Email Address":e.email,Phone:e.getSerializedPhone(),"Evening Phone":e.getSerializedEveningPhone(),"Mobile Phone":e.getSerializedMobilePhone(),Fax:e.getSerializedFax(),Notes:e.notes?e.notes:""}};this.saveNote(n)},t.prototype.savePaymentCardNote=function(e){var t=/([^-]*)-([^-]*)-([^-]*)/g.exec(e.birthday),n=/([^-]*)-([^-]*)-([^-]*)/g.exec(e.birthday),r={group:e.group,name:e.decprofilename,notetype:this.getNoteTypes().CREDIT,pwprotect:e.pwprotect,fav:"0",language:e.profilelanguage,extra:{"Name on Card":e.ccname,Type:"",Number:e.ccnum,"Security Code":e.cccsc,"Start Date":t&&t.length>=2?this.monthNames[Number(t[1])]+","+t[2]:",","Expiration Date":n&&n.length>=2?this.monthNames[Number(n[1])]+","+n[2]:",",Notes:e.notes?e.notes+"\n":""+e.ccissuenum?"Issue number: "+e.ccissuenum:""}};this.saveNote(r)},t.prototype.saveBankAccountNote=function(e){var t={group:e.group,name:e.decprofilename,notetype:this.getNoteTypes().BANK,pwprotect:e.pwprotect,fav:"0",language:e.profilelanguage,extra:{"Bank Name":e.bankname,"Account Type":"","Routing Number":e.bankroutingnum,"Account Number":e.bankacctnum,"SWIFT Code":"","IBAN Number":"",Pin:"","Branch Address":"","Branch Phone":"",Notes:e.notes}};this.saveNote(t)},t.prototype.saveCustomFields=function(e){for(var t=this,n="Formfill "+e.decprofilename,r=[],o=[],i="",a={},s=0,u=e.custom_fields;s<u.length;s++){var p=u[s],c=this.escape(p.text);c.length>this.fieldMaxLength&&(c=c.substring(0,this.fieldMaxLength)),-1!==p.text.indexOf("\n")||-1!==p.value.indexOf("\n")?i+=p.text+":"+p.value+"\n":-1===o.indexOf(c)&&(r.push({text:c,type:"text",options:null}),a[c]=p.value,o.push(c))}""!==i&&(r.push({text:"Notes",type:"textarea",options:null}),a.Notes=i),this.formfillMigrationBackground.createCustomNoteType(n,r,function(o){var i={group:e.group,name:e.decprofilename,notetype:"Custom_"+o,pwprotect:e.pwprotect,fav:"0",language:e.profilelanguage,extra:a,template:JSON.stringify({id:o,title:n,fields:r})};t.saveNote(i)})},t.prototype.escape=function(e){return e.replace(/&/g,"").replace(/</g,"").replace(/>/g,"").replace(/\(/g,"").replace(/\)/g,"").replace(/;/g,"").replace(/:/g,"").replace(/~/g,"").replace(/`/g,"").replace(/"/g,"").replace(/'/g,"")},t.prototype.saveNote=function(e){"undefined"!=typeof Note?this.saveInForeground(e):this.saveInBackground(e)},t.prototype.saveInForeground=function(e){var t=e.group;t||(t=Strings.Consts.NONE_GROUP);var n=LPProxy.getGroupByName(t);if(!n&&t){var r=LPProxy.getExistingGroupParent(t);n=new DummyGroup(t,r?r.getSharedGroup():null)}var o=new Note;o.add=this.getNotePatchedAddFunction(),o.addFromDialog(e,n,{source:"vault"})},t.prototype.saveInBackground=function(e){var t=this;this.formfillMigrationBackground.saveNote(e,function(){t.noteAdditionHandler()})},t.prototype.getNotePatchedAddFunction=function(){return function(e,t){!function(n,r){LPRequest.makeUpdateRequest(LPProxy.addNote,{parameters:[n,e,t],success:function(t){n.update(t,e,r),LPProxy.addItem(n),Topics.get(Topics.NOTE_ADDED).publish(n,e)}})}(this,this._data.attacharraychanges)}},t.prototype.getNoteTypes=function(){return{ADDRESS:"Address",BANK:"Bank Account",CREDIT:"Credit Card",GENERIC:"Generic",SSN:"Social Security"}},t.prototype.attachMigrationQueueExecutor=function(){Topics.get(Topics.NOTE_ADDED).subscribe(this.noteAdditionHandler),this.progressMax=this.migrationQueue.length,this.executeNextMigration()},t.prototype.executeNextMigration=function(){if(this.progress+=1,this.progressCallback&&this.progressCallback(this.progress,this.progressMax),this.migrationQueue.length){this.migrationQueue.pop()()}else Topics.get(Topics.NOTE_ADDED).unsubscribe(this.noteAdditionHandler),Topics.get(Topics.REFRESH_DATA).publish(),this.migrationBackground.sendSegmentEvent("migration::formfill::completed"),this.successCallback()},t.prototype.getBg=function(){return"undefined"!=typeof bg?bg:getBG()},Object.defineProperty(t.prototype,"formfillMigrationBackground",{get:function(){return this.getBg().FormfillMigrationBackground},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"migrationBackground",{get:function(){return this.getBg().MigrationBackground},enumerable:!0,configurable:!0}),t}(Migration),FormfillMigrationBackgroundWeb=function(e){function t(){var t=e.call(this)||this;return t.apiUrl="/lmiapi","string"==typeof base_url&&(t.apiUrl=base_url.replace(/\/$/,"")+t.apiUrl),t}return __extends(t,e),t.prototype.isEnabled=function(){return g_formfill_migration_enabled},t.prototype.createCustomNoteType=function(e,t,n){var r=this;this.getToken(function(o){$.ajax({url:r.apiUrl+"/note-templates",type:"POST",dataType:"json",contentType:"application/json",headers:{"X-CSRF-TOKEN":o},data:JSON.stringify({title:e,method:"web",fields:t}),success:function(e){n(e.id)}})})},t.prototype.saveNote=function(e,t){throw new Error("Migrate in the foreground!")},Object.defineProperty(t.prototype,"encryptedFormfills",{get:function(){return g_formfills},enumerable:!0,configurable:!0}),t.prototype.lpmdec=function(e,t){return lpmdec(e,t)},t.prototype.getToken=function(e){$.post(this.apiUrl+"/csrf",function(t){e(t)})},t}(FormfillStore),FormfillMigrationBackgroundExtension=function(e){function t(){var t=e.call(this)||this;return t.apiUrl="/lmiapi","string"==typeof base_url&&(t.apiUrl=base_url.replace(/\/$/,"")+t.apiUrl),t}return __extends(t,e),t.prototype.isEnabled=function(){return g_formfill_migration_enabled},t.prototype.createCustomNoteType=function(e,t,n){var r=this;this.getToken(function(o){var i={title:e,method:"web",fields:t};LP.lpMakeRequestReallyReal(r.apiUrl+"/note-templates",JSON.stringify(i),function(e){4===e.readyState&&200===e.status?n(JSON.parse(e.responseText).id):4===e.readyState&&lpmakerequesterror("invalidresponse",{url:e.responseURL},!1)},void 0,{"x-csrf-token":o,"Content-Type":"application/json"})})},t.prototype.saveNote=function(e,t){var n={action:"",aid:"0",basic_auth:"0",captcha_id:"",custom_js:"",extra:"",fields:[],group:"",fiid:"",getpw:!1,individualshare:!1,last_touch:"0",method:"",newvalues:[],realm_data:"",sharedfromuid:"",submit_id:"",urid:"0",fav:"0",username:"",password:"",sn:1,url:"http://sn"},r=this.localKey;e.encname=lpmenc(e.name,!0,r);var o="NoteType:"+e.notetype+"\nLanguage:"+(e.language?e.language:"en-US");for(var i in e.extra)o+="\n"+i+":"+e.extra[i];e.extra=lpmenc(o,!0,r);for(var a in n)void 0===e[a]&&(e[a]=n[a]);this.saveSite(e,t)},Object.defineProperty(t.prototype,"encryptedFormfills",{get:function(){return g_formfills},enumerable:!0,configurable:!0}),t.prototype.lpmdec=function(e,t){return lpmdec(e,t)},t.prototype.saveSite=function(e,t){var n=this,r=this.createPostData(e);saveSite(this.serializePostData(r),e,t,function(){setTimeout(function(){n.saveSite(e,t)},3e4)})},t.prototype.createPostData=function(e){var t={};return t.extjs=1,t.localupdate=1,t.ajax=1,t.source="vault",t.aid=e.aid,t.name=lpenc(e.name,this.localKey),t.extra=crypto_btoa(e.extra),e.pwprotect&&(t.pwprotect="on"),"1"===e.fav&&(t.fav="on"),t.url=AES.url2hex(e.url),t.username="",t.password="",t.template=e.template,t.hexName=AES.url2hex(e.name),t.notetype=e.notetype,t},t.prototype.serializePostData=function(e){var t=[];for(var n in e)t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&").replace(/%20/g,"+")},Object.defineProperty(t.prototype,"localKey",{get:function(){return g_local_key},enumerable:!0,configurable:!0}),t.prototype.getToken=function(e){LP.lpMakeRequestReallyReal(this.apiUrl+"/csrf","",function(t){4===t.readyState&&200===t.status?e(JSON.parse(t.responseText)):4===t.readyState&&lpmakerequesterror("invalidresponse",{url:t.responseURL},!1)})},t}(FormfillStore);